<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HMI Sensors</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&family=Rajdhani:wght@300;400;600&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --bg: #050a0e;
      --bg2: #0a1520;
      --panel: #0d1e2e;
      --border: #1a3a5c;
      --accent: #00d4ff;
      --accent2: #00ff9d;
      --accent3: #ff6b35;
      --warn: #ffaa00;
      --text: #c8e6ff;
      --text2: #6a9bbf;
      --red: #ff3860;
      --glow: 0 0 20px rgba(0,212,255,0.3);
      --glow2: 0 0 20px rgba(0,255,157,0.3);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Rajdhani', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* ========== SCREENS ========== */
    .screen {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.6s ease, transform 0.6s ease;
      z-index: 10;
    }
    .screen.hidden {
      opacity: 0;
      pointer-events: none;
      transform: scale(1.03);
    }
    .screen.slide-up {
      transform: translateY(-100%);
      opacity: 0;
      pointer-events: none;
    }

    /* ========== BACKGROUND GRID ========== */
    .grid-bg {
      position: fixed;
      inset: 0;
      background-image:
        linear-gradient(rgba(0,212,255,0.04) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0,212,255,0.04) 1px, transparent 1px);
      background-size: 40px 40px;
      z-index: 0;
    }
    .grid-bg::after {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(ellipse at 50% 50%, transparent 40%, var(--bg) 100%);
    }

    /* ========== WELCOME SCREEN ========== */
    #screen-welcome {
      flex-direction: column;
      text-align: center;
      background: var(--bg);
      z-index: 20;
    }

    .welcome-particles {
      position: absolute;
      inset: 0;
      overflow: hidden;
    }
    .particle {
      position: absolute;
      width: 2px;
      height: 2px;
      background: var(--accent);
      border-radius: 50%;
      animation: float-particle linear infinite;
      opacity: 0;
    }
    @keyframes float-particle {
      0% { transform: translateY(100vh) translateX(0); opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { transform: translateY(-100px) translateX(50px); opacity: 0; }
    }

    .welcome-content {
      position: relative;
      z-index: 2;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 24px;
    }

    .welcome-badge {
      font-family: 'Share Tech Mono', monospace;
      font-size: 11px;
      letter-spacing: 4px;
      color: var(--accent);
      text-transform: uppercase;
      border: 1px solid rgba(0,212,255,0.3);
      padding: 6px 20px;
      animation: pulse-border 2s ease-in-out infinite;
    }
    @keyframes pulse-border {
      0%, 100% { border-color: rgba(0,212,255,0.3); }
      50% { border-color: rgba(0,212,255,0.8); box-shadow: var(--glow); }
    }

    .welcome-title {
      font-family: 'Orbitron', monospace;
      font-size: clamp(48px, 8vw, 96px);
      font-weight: 900;
      line-height: 0.9;
      letter-spacing: -2px;
      background: linear-gradient(135deg, #fff 0%, var(--accent) 50%, var(--accent2) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: title-glow 3s ease-in-out infinite alternate;
    }
    @keyframes title-glow {
      from { filter: drop-shadow(0 0 10px rgba(0,212,255,0.3)); }
      to { filter: drop-shadow(0 0 30px rgba(0,212,255,0.7)); }
    }

    .welcome-subtitle {
      font-family: 'Rajdhani', sans-serif;
      font-size: 18px;
      font-weight: 300;
      letter-spacing: 6px;
      color: var(--text2);
      text-transform: uppercase;
    }

    .welcome-line {
      width: 200px;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--accent), transparent);
      animation: line-pulse 2s ease-in-out infinite;
    }
    @keyframes line-pulse {
      0%, 100% { opacity: 0.5; width: 200px; }
      50% { opacity: 1; width: 300px; }
    }

    .welcome-stats {
      display: flex;
      gap: 40px;
      font-family: 'Share Tech Mono', monospace;
      font-size: 11px;
      color: var(--text2);
      letter-spacing: 2px;
    }
    .welcome-stats span { color: var(--accent2); }

    .btn-start {
      margin-top: 20px;
      padding: 16px 60px;
      font-family: 'Orbitron', monospace;
      font-size: 14px;
      font-weight: 700;
      letter-spacing: 4px;
      text-transform: uppercase;
      color: var(--bg);
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      border: none;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      clip-path: polygon(12px 0%, 100% 0%, calc(100% - 12px) 100%, 0% 100%);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .btn-start:hover {
      transform: scale(1.05);
      box-shadow: 0 0 40px rgba(0,212,255,0.5), 0 0 80px rgba(0,255,157,0.3);
    }
    .btn-start::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, transparent 40%, rgba(255,255,255,0.2) 50%, transparent 60%);
      transform: translateX(-100%);
      transition: transform 0.4s;
    }
    .btn-start:hover::after { transform: translateX(100%); }

    .corner-deco {
      position: absolute;
      width: 60px;
      height: 60px;
      border-color: rgba(0,212,255,0.4);
      border-style: solid;
    }
    .corner-deco.tl { top: 30px; left: 30px; border-width: 2px 0 0 2px; }
    .corner-deco.tr { top: 30px; right: 30px; border-width: 2px 2px 0 0; }
    .corner-deco.bl { bottom: 30px; left: 30px; border-width: 0 0 2px 2px; }
    .corner-deco.br { bottom: 30px; right: 30px; border-width: 0 2px 2px 0; }

    /* ========== AUTH SCREEN ========== */
    #screen-auth {
      background: var(--bg);
      z-index: 15;
    }

    .auth-container {
      width: 100%;
      max-width: 440px;
      padding: 20px;
      position: relative;
      z-index: 2;
    }

    .auth-header {
      text-align: center;
      margin-bottom: 32px;
    }
    .auth-logo {
      font-family: 'Orbitron', monospace;
      font-size: 28px;
      font-weight: 900;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 6px;
    }
    .auth-tagline {
      font-family: 'Share Tech Mono', monospace;
      font-size: 10px;
      letter-spacing: 3px;
      color: var(--text2);
      text-transform: uppercase;
    }

    .auth-card {
      background: var(--panel);
      border: 1px solid var(--border);
      padding: 32px;
      position: relative;
      clip-path: polygon(0 0, calc(100% - 20px) 0, 100% 20px, 100% 100%, 20px 100%, 0 calc(100% - 20px));
    }
    .auth-card::before {
      content: '';
      position: absolute;
      top: -1px; right: 19px;
      width: 28px; height: 1px;
      background: var(--accent);
      transform: rotate(45deg) translateX(10px);
      transform-origin: right;
    }

    .auth-tabs {
      display: flex;
      margin-bottom: 28px;
      border-bottom: 1px solid var(--border);
    }
    .auth-tab {
      flex: 1;
      padding: 10px;
      text-align: center;
      font-family: 'Orbitron', monospace;
      font-size: 11px;
      letter-spacing: 2px;
      color: var(--text2);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.3s;
      background: none;
      border-top: none;
      border-left: none;
      border-right: none;
    }
    .auth-tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    .auth-form { display: none; flex-direction: column; gap: 16px; }
    .auth-form.active { display: flex; }

    .field-group { display: flex; flex-direction: column; gap: 6px; }
    .field-label {
      font-family: 'Share Tech Mono', monospace;
      font-size: 10px;
      letter-spacing: 2px;
      color: var(--accent);
      text-transform: uppercase;
    }
    .field-input {
      background: rgba(0,212,255,0.05);
      border: 1px solid var(--border);
      padding: 12px 16px;
      color: var(--text);
      font-family: 'Rajdhani', sans-serif;
      font-size: 15px;
      outline: none;
      transition: border-color 0.3s, box-shadow 0.3s;
      width: 100%;
    }
    .field-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 10px rgba(0,212,255,0.2);
    }
    .field-input::placeholder { color: var(--text2); opacity: 0.5; }

    .field-wrap {
      position: relative;
      display: flex;
      align-items: center;
    }
    .field-wrap .field-input {
      padding-right: 36px;
    }
    .btn-clear {
      position: absolute;
      right: 10px;
      background: none;
      border: none;
      cursor: pointer;
      color: var(--text2);
      font-size: 14px;
      padding: 4px;
      opacity: 0;
      transition: opacity 0.2s, color 0.2s;
      line-height: 1;
      pointer-events: none;
    }
    .btn-clear.visible {
      opacity: 1;
      pointer-events: all;
    }
    .btn-clear:hover { color: var(--red); }

    .btn-eye {
      position: absolute;
      right: 34px;
      background: none;
      border: none;
      cursor: pointer;
      color: var(--text2);
      font-size: 13px;
      padding: 4px;
      transition: color 0.2s;
      line-height: 1;
    }
    .btn-eye:hover { color: var(--accent); }
    .field-wrap .field-input.with-eye {
      padding-right: 64px;
    }

    .btn-auth {
      padding: 14px;
      font-family: 'Orbitron', monospace;
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 3px;
      text-transform: uppercase;
      color: var(--bg);
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      border: none;
      cursor: pointer;
      margin-top: 8px;
      transition: opacity 0.3s, transform 0.2s;
    }
    .btn-auth:hover { opacity: 0.9; transform: translateY(-1px); }
    .btn-auth:disabled { opacity: 0.5; cursor: not-allowed; }

    .auth-error {
      font-family: 'Share Tech Mono', monospace;
      font-size: 11px;
      color: var(--red);
      text-align: center;
      min-height: 16px;
      letter-spacing: 1px;
    }

    /* ========== HMI SCREEN ========== */
    #screen-hmi {
      background: var(--bg);
      z-index: 5;
      align-items: flex-start;
      overflow-y: auto;
      padding: 0;
    }

    .hmi-wrapper {
      width: 100%;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      position: relative;
      z-index: 2;
    }

    /* TOPBAR */
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 32px;
      border-bottom: 1px solid var(--border);
      background: rgba(10,21,32,0.9);
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .topbar-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .topbar-logo {
      font-family: 'Orbitron', monospace;
      font-size: 18px;
      font-weight: 900;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .topbar-sep { width: 1px; height: 30px; background: var(--border); }
    .topbar-info {
      font-family: 'Share Tech Mono', monospace;
      font-size: 10px;
      color: var(--text2);
      letter-spacing: 1px;
    }
    .topbar-info span { color: var(--accent2); }

    .topbar-right { display: flex; align-items: center; gap: 16px; }

    .status-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: var(--accent2);
      box-shadow: 0 0 8px var(--accent2);
      animation: blink 1.5s ease-in-out infinite;
    }
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }
    .status-text {
      font-family: 'Share Tech Mono', monospace;
      font-size: 10px;
      color: var(--accent2);
      letter-spacing: 2px;
    }

    .btn-icon {
      background: rgba(0,212,255,0.08);
      border: 1px solid var(--border);
      color: var(--text2);
      padding: 8px 14px;
      font-family: 'Share Tech Mono', monospace;
      font-size: 10px;
      letter-spacing: 2px;
      cursor: pointer;
      transition: all 0.3s;
      text-transform: uppercase;
    }
    .btn-icon:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(0,212,255,0.12);
    }
    .btn-logout {
      background: rgba(255,56,96,0.08);
      border-color: rgba(255,56,96,0.3);
      color: var(--red);
    }
    .btn-logout:hover {
      background: rgba(255,56,96,0.15);
      border-color: var(--red);
      color: var(--red);
    }

    /* MAIN CONTENT */
    .hmi-main { padding: 32px; display: flex; flex-direction: column; gap: 28px; }

    .section-title {
      font-family: 'Orbitron', monospace;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 4px;
      color: var(--text2);
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }
    .section-title::after {
      content: '';
      flex: 1;
      height: 1px;
      background: linear-gradient(90deg, var(--border), transparent);
    }

    /* SENSOR CARDS */
    .sensors-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
    }

    .sensor-card {
      background: var(--panel);
      border: 1px solid var(--border);
      padding: 24px;
      position: relative;
      overflow: hidden;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    .sensor-card:hover {
      border-color: var(--accent);
      box-shadow: var(--glow);
    }
    .sensor-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 2px;
    }
    .sensor-card.current::before { background: linear-gradient(90deg, var(--accent), transparent); }
    .sensor-card.vibration::before { background: linear-gradient(90deg, var(--accent2), transparent); }
    .sensor-card.thermal::before { background: linear-gradient(90deg, var(--accent3), transparent); }

    .card-corner {
      position: absolute;
      top: 0; right: 0;
      width: 0; height: 0;
      border-style: solid;
    }
    .sensor-card.current .card-corner { border-width: 0 28px 28px 0; border-color: transparent var(--accent) transparent transparent; }
    .sensor-card.vibration .card-corner { border-width: 0 28px 28px 0; border-color: transparent var(--accent2) transparent transparent; }
    .sensor-card.thermal .card-corner { border-width: 0 28px 28px 0; border-color: transparent var(--accent3) transparent transparent; }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }
    .card-icon {
      font-size: 28px;
      line-height: 1;
    }
    .card-label {
      font-family: 'Share Tech Mono', monospace;
      font-size: 9px;
      letter-spacing: 3px;
      text-transform: uppercase;
    }
    .sensor-card.current .card-label { color: var(--accent); }
    .sensor-card.vibration .card-label { color: var(--accent2); }
    .sensor-card.thermal .card-label { color: var(--accent3); }

    .card-id {
      font-family: 'Share Tech Mono', monospace;
      font-size: 9px;
      color: var(--text2);
      opacity: 0.5;
    }

    .card-value {
      font-family: 'Orbitron', monospace;
      font-size: 48px;
      font-weight: 900;
      line-height: 1;
      margin-bottom: 4px;
    }
    .sensor-card.current .card-value { color: var(--accent); text-shadow: 0 0 20px rgba(0,212,255,0.4); }
    .sensor-card.vibration .card-value { color: var(--accent2); text-shadow: 0 0 20px rgba(0,255,157,0.4); }
    .sensor-card.thermal .card-value { color: var(--accent3); text-shadow: 0 0 20px rgba(255,107,53,0.4); }

    .card-unit {
      font-family: 'Rajdhani', sans-serif;
      font-size: 14px;
      font-weight: 300;
      letter-spacing: 2px;
      color: var(--text2);
      margin-bottom: 20px;
    }

    .card-bar-bg {
      height: 4px;
      background: rgba(255,255,255,0.06);
      border-radius: 2px;
      overflow: hidden;
      margin-bottom: 12px;
    }
    .card-bar {
      height: 100%;
      border-radius: 2px;
      transition: width 0.8s cubic-bezier(0.4,0,0.2,1);
    }
    .sensor-card.current .card-bar { background: linear-gradient(90deg, var(--accent), rgba(0,212,255,0.5)); }
    .sensor-card.vibration .card-bar { background: linear-gradient(90deg, var(--accent2), rgba(0,255,157,0.5)); }
    .sensor-card.thermal .card-bar { background: linear-gradient(90deg, var(--accent3), rgba(255,107,53,0.5)); }

    .card-footer {
      display: flex;
      justify-content: space-between;
      font-family: 'Share Tech Mono', monospace;
      font-size: 9px;
      color: var(--text2);
      letter-spacing: 1px;
    }

    .card-status {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .card-status-dot {
      width: 6px; height: 6px;
      border-radius: 50%;
      background: var(--accent2);
      box-shadow: 0 0 6px var(--accent2);
      animation: blink 2s ease-in-out infinite;
    }
    .card-status-dot.warn { background: var(--warn); box-shadow: 0 0 6px var(--warn); }
    .card-status-dot.danger { background: var(--red); box-shadow: 0 0 6px var(--red); animation: blink 0.5s ease-in-out infinite; }

    /* CHART AREA */
    .chart-section {
      background: var(--panel);
      border: 1px solid var(--border);
      padding: 24px;
    }
    .chart-canvas-wrap {
      position: relative;
      height: 180px;
      overflow: hidden;
    }
    canvas#chartCanvas {
      width: 100%;
      height: 100%;
    }

    /* LAST UPDATE */
    .last-update {
      font-family: 'Share Tech Mono', monospace;
      font-size: 10px;
      color: var(--text2);
      letter-spacing: 2px;
      text-align: right;
    }
    .last-update span { color: var(--accent); }

    /* ========== ADMIN PANEL ========== */
    #screen-admin {
      background: var(--bg);
      z-index: 8;
      align-items: flex-start;
      overflow-y: auto;
      padding: 0;
    }

    .admin-wrapper {
      width: 100%;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      position: relative;
      z-index: 2;
    }

    .admin-content { padding: 32px; }

    .admin-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 28px;
    }
    .admin-stat {
      background: var(--panel);
      border: 1px solid var(--border);
      padding: 20px;
      text-align: center;
    }
    .admin-stat-num {
      font-family: 'Orbitron', monospace;
      font-size: 36px;
      font-weight: 900;
      color: var(--accent);
    }
    .admin-stat-label {
      font-family: 'Share Tech Mono', monospace;
      font-size: 9px;
      letter-spacing: 2px;
      color: var(--text2);
      text-transform: uppercase;
      margin-top: 4px;
    }

    .admin-table-wrap {
      background: var(--panel);
      border: 1px solid var(--border);
      overflow: hidden;
    }
    .admin-table {
      width: 100%;
      border-collapse: collapse;
    }
    .admin-table th {
      font-family: 'Share Tech Mono', monospace;
      font-size: 9px;
      letter-spacing: 2px;
      color: var(--accent);
      text-transform: uppercase;
      padding: 14px 20px;
      text-align: left;
      border-bottom: 1px solid var(--border);
      background: rgba(0,212,255,0.04);
    }
    .admin-table td {
      font-family: 'Rajdhani', sans-serif;
      font-size: 14px;
      color: var(--text);
      padding: 12px 20px;
      border-bottom: 1px solid rgba(26,58,92,0.5);
    }
    .admin-table tr:last-child td { border-bottom: none; }
    .admin-table tr:hover td { background: rgba(0,212,255,0.03); }
    .admin-table .mono {
      font-family: 'Share Tech Mono', monospace;
      font-size: 11px;
      color: var(--text2);
    }
    .badge {
      display: inline-block;
      padding: 2px 10px;
      font-family: 'Share Tech Mono', monospace;
      font-size: 9px;
      letter-spacing: 1px;
      text-transform: uppercase;
    }
    .badge.admin { background: rgba(0,212,255,0.15); color: var(--accent); border: 1px solid rgba(0,212,255,0.3); }
    .badge.user { background: rgba(0,255,157,0.1); color: var(--accent2); border: 1px solid rgba(0,255,157,0.2); }

    /* LOADER */
    .loader-wrap {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      gap: 20px;
      position: fixed;
      inset: 0;
      background: var(--bg);
      z-index: 50;
      transition: opacity 0.5s;
    }
    .loader-wrap.hidden { opacity: 0; pointer-events: none; }
    .loader-ring {
      width: 60px;
      height: 60px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loader-text {
      font-family: 'Share Tech Mono', monospace;
      font-size: 10px;
      letter-spacing: 3px;
      color: var(--accent);
      text-transform: uppercase;
    }

    /* NOTIFICATION */
    .notif {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-left: 3px solid var(--accent);
      padding: 14px 20px;
      font-family: 'Share Tech Mono', monospace;
      font-size: 11px;
      color: var(--text);
      letter-spacing: 1px;
      z-index: 999;
      transform: translateX(120%);
      transition: transform 0.4s cubic-bezier(0.4,0,0.2,1);
      max-width: 300px;
    }
    .notif.show { transform: translateX(0); }
    .notif.error { border-left-color: var(--red); }
    .notif.success { border-left-color: var(--accent2); }

    /* SCAN LINE */
    .scanline {
      position: fixed;
      top: 0; left: 0; right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--accent), transparent);
      opacity: 0.15;
      animation: scan 6s linear infinite;
      pointer-events: none;
      z-index: 1000;
    }
    @keyframes scan {
      0% { top: 0; }
      100% { top: 100vh; }
    }

    .thermal-sub {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 4px;
      padding: 10px 0 0;
      border-top: 1px solid rgba(255,107,53,0.15);
    }
    .thermal-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .thermal-label {
      font-family: 'Share Tech Mono', monospace;
      font-size: 9px;
      letter-spacing: 2px;
      color: var(--text2);
      text-transform: uppercase;
    }
    .thermal-val {
      font-family: 'Orbitron', monospace;
      font-size: 14px;
      font-weight: 700;
      color: var(--accent3);
    }

    @media (max-width: 600px) {
      .topbar { padding: 12px 16px; }
      .hmi-main, .admin-content { padding: 16px; }
      .sensors-grid { grid-template-columns: 1fr; }
      .welcome-title { font-size: 48px; }
      .welcome-stats { flex-direction: column; gap: 8px; }
      .auth-card { padding: 20px; }
    }
  </style>
</head>
<body>

<div class="grid-bg"></div>
<div class="scanline"></div>

<!-- LOADER -->
<div class="loader-wrap" id="loader">
  <div class="loader-ring"></div>
  <div class="loader-text">Inicializando sistema...</div>
</div>

<!-- NOTIFICATION -->
<div class="notif" id="notif"></div>

<!-- ========== WELCOME SCREEN ========== -->
<div class="screen" id="screen-welcome">
  <div class="corner-deco tl"></div>
  <div class="corner-deco tr"></div>
  <div class="corner-deco bl"></div>
  <div class="corner-deco br"></div>

  <div class="welcome-particles" id="particles"></div>

  <div class="welcome-content">
    <div class="welcome-badge">Sistema de Monitoreo Industrial</div>
    <div class="welcome-title">HMI<br>SENSORS</div>
    <div class="welcome-subtitle">Control &amp; Diagn√≥stico en Tiempo Real</div>
    <div class="welcome-line"></div>
    <div class="welcome-stats">
      <div>SENSORES: <span>03</span></div>
      <div>PROTOCOLO: <span>ESP32</span></div>
      <div>RED: <span>FIREBASE</span></div>
    </div>
    <button class="btn-start" onclick="startSystem()">‚ñ∂ INICIAR SISTEMA</button>
  </div>
</div>

<!-- ========== AUTH SCREEN ========== -->
<div class="screen hidden" id="screen-auth">
  <style>
    .btn-back {
      position: absolute;
      top: 24px;
      left: 24px;
      z-index: 10;
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
    }
    .btn-back svg {
      display: block;
      transition: transform 0.3s ease;
      filter: drop-shadow(0 0 6px rgba(0,212,255,0.4));
    }
    .btn-back:hover svg {
      transform: translateX(-4px);
      filter: drop-shadow(0 0 14px rgba(0,212,255,0.9));
    }
    .btn-back .arrow-path {
      stroke-dasharray: 120;
      stroke-dashoffset: 120;
      animation: draw-arrow 0.8s ease forwards 0.3s;
    }
    .btn-back .shape-path {
      stroke-dasharray: 300;
      stroke-dashoffset: 300;
      animation: draw-arrow 1s ease forwards 0.1s;
    }
    @keyframes draw-arrow {
      to { stroke-dashoffset: 0; }
    }
  </style>
  <button class="btn-back" onclick="goBackToWelcome()" title="Volver">
    <svg width="64" height="40" viewBox="0 0 64 40" fill="none" xmlns="http://www.w3.org/2000/svg">
      <!-- Hexagon-cut shape like the START button -->
      <path class="shape-path" d="M10 2 H54 L62 20 L54 38 H10 L2 20 Z"
        stroke="rgba(0,212,255,0.6)" stroke-width="1.2" fill="rgba(0,212,255,0.06)"/>
      <!-- Arrow left -->
      <path class="arrow-path" d="M36 20 H20 M20 20 L28 13 M20 20 L28 27"
        stroke="#00d4ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <!-- Small accent dot -->
      <circle cx="44" cy="20" r="2" fill="rgba(0,255,157,0.7)"/>
    </svg>
  </button>
  <div class="auth-container">
    <div class="auth-header">
      <div class="auth-logo">HMI SENSORS</div>
      <div class="auth-tagline">Acceso al sistema de monitoreo</div>
    </div>

    <div class="auth-card">
      <div class="auth-tabs">
        <button class="auth-tab active" onclick="switchTab('login')">ACCEDER</button>
        <button class="auth-tab" onclick="switchTab('register')">REGISTRARSE</button>
      </div>

      <!-- LOGIN -->
      <div class="auth-form active" id="form-login">
        <div class="field-group">
          <label class="field-label">Correo electr√≥nico</label>
          <div class="field-wrap">
            <input class="field-input" type="email" id="login-email" placeholder="usuario@ejemplo.com"
              oninput="toggleClear('clear-login-email', this.value)"/>
            <button class="btn-clear" id="clear-login-email" onclick="clearField('login-email', 'clear-login-email')" tabindex="-1">‚úï</button>
          </div>
        </div>
        <div class="field-group">
          <label class="field-label">Contrase√±a</label>
          <div class="field-wrap">
            <input class="field-input with-eye" type="password" id="login-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
              oninput="toggleClear('clear-login-pass', this.value)"/>
            <button class="btn-eye" onclick="togglePassword('login-pass', this)" tabindex="-1" title="Mostrar contrase√±a"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
            <button class="btn-clear" id="clear-login-pass" onclick="clearPassOnly('login-pass', 'clear-login-pass')" tabindex="-1">‚úï</button>
          </div>
        </div>
        <div class="auth-error" id="login-error"></div>
        <button class="btn-auth" id="btn-login" onclick="doLogin()">ACCEDER AL SISTEMA</button>
      </div>

      <!-- REGISTER -->
      <div class="auth-form" id="form-register">
        <div class="field-group">
          <label class="field-label">Nombre completo</label>
          <div class="field-wrap">
            <input class="field-input" type="text" id="reg-name" placeholder="Tu nombre"
              oninput="toggleClear('clear-reg-name', this.value)"/>
            <button class="btn-clear" id="clear-reg-name" onclick="clearField('reg-name', 'clear-reg-name')" tabindex="-1">‚úï</button>
          </div>
        </div>
        <div class="field-group">
          <label class="field-label">Correo electr√≥nico</label>
          <div class="field-wrap">
            <input class="field-input" type="email" id="reg-email" placeholder="usuario@ejemplo.com"
              oninput="toggleClear('clear-reg-email', this.value)"/>
            <button class="btn-clear" id="clear-reg-email" onclick="clearField('reg-email', 'clear-reg-email')" tabindex="-1">‚úï</button>
          </div>
        </div>
        <div class="field-group">
          <label class="field-label">Contrase√±a</label>
          <div class="field-wrap">
            <input class="field-input with-eye" type="password" id="reg-pass" placeholder="M√≠nimo 6 caracteres"
              oninput="toggleClear('clear-reg-pass', this.value)"/>
            <button class="btn-eye" onclick="togglePassword('reg-pass', this)" tabindex="-1" title="Mostrar contrase√±a"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
            <button class="btn-clear" id="clear-reg-pass" onclick="clearPassOnly('reg-pass', 'clear-reg-pass')" tabindex="-1">‚úï</button>
          </div>
        </div>
        <div class="auth-error" id="reg-error"></div>
        <button class="btn-auth" id="btn-register" onclick="doRegister()">CREAR CUENTA</button>
      </div>
    </div>
  </div>
</div>

<!-- ========== HMI SCREEN ========== -->
<div class="screen hidden" id="screen-hmi">
  <div class="hmi-wrapper">
    <div class="topbar">
      <div class="topbar-left">
        <div class="topbar-logo">HMI SENSORS</div>
        <div class="topbar-sep"></div>
        <div class="topbar-info">USUARIO: <span id="user-display">‚Äî</span></div>
      </div>
      <div class="topbar-right">
        <div class="status-dot" id="conn-dot"></div>
        <div class="status-text" id="conn-text">CONECTANDO...</div>
        <button class="btn-icon" id="btn-admin-panel" onclick="showAdmin()" style="display:none">‚öô ADMIN</button>
        <button class="btn-icon btn-logout" onclick="doLogout()">SALIR</button>
      </div>
    </div>

    <div class="hmi-main">
      <div>
        <div class="section-title">Monitoreo de Sensores</div>
        <div class="sensors-grid">

          <!-- CORRIENTE -->
          <div class="sensor-card current">
            <div class="card-corner"></div>
            <div class="card-header">
              <span class="card-icon">‚ö°</span>
              <div>
                <div class="card-label">Sensor de Corriente</div>
                <div class="card-id">Hall Effect ‚Äî HQHSGCGVA 100A</div>
              </div>
            </div>
            <div class="card-value" id="val-current">‚Äî</div>
            <div class="card-unit">AMPERIOS (A)</div>
            <div class="card-bar-bg"><div class="card-bar" id="bar-current" style="width:0%"></div></div>
            <div class="card-footer">
              <div class="card-status">
                <div class="card-status-dot" id="dot-current"></div>
                <span id="status-current">ESPERANDO...</span>
              </div>
              <span id="range-current">0 ‚Äì 10 A</span>
            </div>
          </div>

          <!-- VIBRACI√ìN -->
          <div class="sensor-card vibration">
            <div class="card-corner"></div>
            <div class="card-header">
              <span class="card-icon">„Ä∞</span>
              <div>
                <div class="card-label">Sensor de Vibraci√≥n</div>
                <div class="card-id">MEMS Aceler√≥metro ‚Äî LIS2DW12</div>
              </div>
            </div>
            <div class="card-value" id="val-vibration">‚Äî</div>
            <div class="card-unit">m/s¬≤</div>
            <div class="card-bar-bg"><div class="card-bar" id="bar-vibration" style="width:0%"></div></div>
            <div class="card-footer">
              <div class="card-status">
                <div class="card-status-dot" id="dot-vibration"></div>
                <span id="status-vibration">ESPERANDO...</span>
              </div>
              <span id="range-vibration">0 ‚Äì 80 m/s¬≤</span>
            </div>
          </div>

          <!-- C√ÅMARA T√âRMICA -->
          <div class="sensor-card thermal">
            <div class="card-corner"></div>
            <div class="card-header">
              <span class="card-icon">üå°</span>
              <div>
                <div class="card-label">C√°mara T√©rmica</div>
                <div class="card-id">MLX90640 ‚Äî SEN-TMP-01</div>
              </div>
            </div>
            <div class="card-value" id="val-thermal">‚Äî</div>
            <div class="card-unit">¬∞C ‚Äî TEMPERATURA M√ÅXIMA</div>
            <div class="card-bar-bg"><div class="card-bar" id="bar-thermal" style="width:0%"></div></div>
            <div class="thermal-sub">
              <div class="thermal-row">
                <span class="thermal-label">AMBIENTE</span>
                <span class="thermal-val" id="val-thermal-amb">‚Äî ¬∞C</span>
              </div>
              <div class="thermal-row">
                <span class="thermal-label">PROMEDIO</span>
                <span class="thermal-val" id="val-thermal-avg">‚Äî ¬∞C</span>
              </div>
            </div>
            <div class="card-footer" style="margin-top:12px">
              <div class="card-status">
                <div class="card-status-dot" id="dot-thermal"></div>
                <span id="status-thermal">ESPERANDO...</span>
              </div>
              <span>0 ‚Äì 100 ¬∞C</span>
            </div>
          </div>

        </div>
      </div>

      <!-- HISTORIAL GR√ÅFICO -->
      <div class="chart-section">
        <div class="section-title">Historial ‚Äî √öltimas lecturas</div>
        <div class="chart-canvas-wrap">
          <canvas id="chartCanvas"></canvas>
        </div>
      </div>

      <div class="last-update">
        √öltima actualizaci√≥n: <span id="last-update-time">‚Äî</span>
      </div>
    </div>
  </div>
</div>

<!-- ========== ADMIN SCREEN ========== -->
<div class="screen hidden" id="screen-admin">
  <div class="admin-wrapper">
    <div class="topbar">
      <div class="topbar-left">
        <div class="topbar-logo">HMI SENSORS</div>
        <div class="topbar-sep"></div>
        <div class="topbar-info" style="color:var(--accent)">‚öô PANEL ADMINISTRADOR</div>
      </div>
      <div class="topbar-right">
        <button class="btn-icon" onclick="showHMI()">‚Üê VOLVER AL HMI</button>
        <button class="btn-icon btn-logout" onclick="doLogout()">SALIR</button>
      </div>
    </div>

    <div class="admin-content">
      <div class="section-title">Resumen del Sistema</div>
      <div class="admin-stats">
        <div class="admin-stat">
          <div class="admin-stat-num" id="stat-users">0</div>
          <div class="admin-stat-label">Usuarios Registrados</div>
        </div>
        <div class="admin-stat">
          <div class="admin-stat-num" id="stat-logins">0</div>
          <div class="admin-stat-label">Accesos Totales</div>
        </div>
        <div class="admin-stat">
          <div class="admin-stat-num" id="stat-readings">0</div>
          <div class="admin-stat-label">Accesos Hoy</div>
        </div>
      </div>

      <div class="section-title">Registro de Accesos</div>
      <div class="admin-table-wrap">
        <table class="admin-table">
          <thead>
            <tr>
              <th>Usuario</th>
              <th>Correo</th>
              <th>Fecha y Hora</th>
              <th>Rol</th>
              <th>Acceso</th>
            </tr>
          </thead>
          <tbody id="admin-table-body">
            <tr><td colspan="4" style="text-align:center;color:var(--text2);font-family:'Share Tech Mono',monospace;font-size:11px;padding:30px">CARGANDO REGISTROS...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Firebase SDKs -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { getDatabase, ref, onValue, set, push, get, child } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

  // ===== FIREBASE CONFIG =====
  const firebaseConfig = {
    apiKey: "AIzaSyBJeVtQAT7NtmBDkhX5Tt53pVOh9bp58RM",
    authDomain: "integradora-8f172.firebaseapp.com",
    databaseURL: "https://integradora-8f172-default-rtdb.firebaseio.com",
    projectId: "integradora-8f172",
    storageBucket: "integradora-8f172.firebasestorage.app",
    messagingSenderId: "483392137641",
    appId: "1:483392137641:web:a0c1224c155d36494c7cb8"
  };

  const ADMIN_EMAIL = "admin@hmi.com";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  // ===== CHART DATA =====
  const chartHistory = { current: [], vibration: [] };
  const MAX_POINTS = 20;

  // ===== PARTICLES =====
  function createParticles() {
    const container = document.getElementById('particles');
    for (let i = 0; i < 30; i++) {
      const p = document.createElement('div');
      p.className = 'particle';
      p.style.cssText = `
        left: ${Math.random()*100}%;
        animation-duration: ${4 + Math.random()*8}s;
        animation-delay: ${Math.random()*6}s;
        width: ${1 + Math.random()*3}px;
        height: ${1 + Math.random()*3}px;
        opacity: 0;
      `;
      container.appendChild(p);
    }
  }
  createParticles();

  // ===== NOTIFICATIONS =====
  function notify(msg, type='info') {
    const el = document.getElementById('notif');
    el.textContent = msg;
    el.className = `notif ${type} show`;
    setTimeout(() => el.classList.remove('show'), 3000);
  }

  // ===== SCREEN TRANSITIONS =====
  window.startSystem = function() {
    const welcome = document.getElementById('screen-welcome');
    welcome.classList.add('slide-up');
    setTimeout(() => {
      welcome.classList.add('hidden');
      const auth_screen = document.getElementById('screen-auth');
      auth_screen.classList.remove('hidden');
    }, 600);
  };

  function showScreen(id) {
    ['screen-welcome','screen-auth','screen-hmi','screen-admin'].forEach(s => {
      document.getElementById(s).classList.add('hidden');
    });
    document.getElementById(id).classList.remove('hidden');
  }

  window.showHMI = function() { showScreen('screen-hmi'); };

  window.goBackToWelcome = function() {
    const authScreen = document.getElementById('screen-auth');
    authScreen.classList.add('hidden');
    const welcome = document.getElementById('screen-welcome');
    welcome.classList.remove('hidden');
    welcome.classList.remove('slide-up');
  };
  window.showAdmin = function() {
    showScreen('screen-admin');
    loadAdminData();
  };

  // ===== TABS =====
  window.switchTab = function(tab) {
    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById('form-' + tab).classList.add('active');
  };

  // ===== AUTH =====
  window.doLogin = async function() {
    const email = document.getElementById('login-email').value.trim();
    const pass = document.getElementById('login-pass').value;
    const errEl = document.getElementById('login-error');
    const btn = document.getElementById('btn-login');
    errEl.textContent = '';
    if (!email || !pass) { errEl.textContent = 'COMPLETA TODOS LOS CAMPOS'; return; }
    btn.disabled = true;
    btn.textContent = 'VERIFICANDO...';
    try {
      await signInWithEmailAndPassword(auth, email, pass);
    } catch(e) {
      errEl.textContent = getAuthError(e.code);
      btn.disabled = false;
      btn.textContent = 'ACCEDER AL SISTEMA';
    }
  };

  window.doRegister = async function() {
    const name = document.getElementById('reg-name').value.trim();
    const email = document.getElementById('reg-email').value.trim();
    const pass = document.getElementById('reg-pass').value;
    const errEl = document.getElementById('reg-error');
    const btn = document.getElementById('btn-register');
    errEl.textContent = '';
    if (!name || !email || !pass) { errEl.textContent = 'COMPLETA TODOS LOS CAMPOS'; return; }
    if (pass.length < 6) { errEl.textContent = 'CONTRASE√ëA M√çNIMO 6 CARACTERES'; return; }
    btn.disabled = true;
    btn.textContent = 'REGISTRANDO...';
    try {
      const cred = await createUserWithEmailAndPassword(auth, email, pass);
      await updateProfile(cred.user, { displayName: name });
      notify('Cuenta creada exitosamente', 'success');
    } catch(e) {
      errEl.textContent = getAuthError(e.code);
      btn.disabled = false;
      btn.textContent = 'CREAR CUENTA';
    }
  };

  window.doLogout = async function() {
    await signOut(auth);
    // Reset login button
    const btnLogin = document.getElementById('btn-login');
    if (btnLogin) { btnLogin.disabled = false; btnLogin.textContent = 'ACCEDER AL SISTEMA'; }
    // Reset register button
    const btnReg = document.getElementById('btn-register');
    if (btnReg) { btnReg.disabled = false; btnReg.textContent = 'CREAR CUENTA'; }
    // Clear error messages
    document.getElementById('login-error').textContent = '';
    document.getElementById('reg-error').textContent = '';
    showScreen('screen-auth');
    notify('Sesi√≥n cerrada', 'info');
  };

  function getAuthError(code) {
    const errors = {
      'auth/invalid-email': 'CORREO INV√ÅLIDO',
      'auth/user-not-found': 'USUARIO NO ENCONTRADO',
      'auth/wrong-password': 'CONTRASE√ëA INCORRECTA',
      'auth/email-already-in-use': 'CORREO YA REGISTRADO',
      'auth/weak-password': 'CONTRASE√ëA MUY D√âBIL',
      'auth/invalid-credential': 'CREDENCIALES INCORRECTAS',
      'auth/too-many-requests': 'DEMASIADOS INTENTOS, ESPERA UN MOMENTO',
    };
    return errors[code] || 'ERROR: ' + code;
  }

  // ===== AUTH STATE =====
  onAuthStateChanged(auth, async (user) => {
    document.getElementById('loader').classList.add('hidden');
    if (user) {
      const isAdmin = user.email === ADMIN_EMAIL;

      // Check if user is blocked
      if (!isAdmin) {
        const emailKey = user.email.replace(/\./g, '_').replace(/@/g, '_at_');
        const blockedSnap = await get(ref(db, 'blocked_users/' + emailKey));
        if (blockedSnap.val() === true) {
          await signOut(auth);
          notify('ACCESO DENEGADO ‚Äî Cuenta bloqueada', 'error');
          showScreen('screen-auth');
          document.getElementById('login-error').textContent = 'ACCESO DENEGADO ‚Äî CUENTA BLOQUEADA';
          return;
        }
      }

      const displayName = user.displayName || user.email.split('@')[0];
      document.getElementById('user-display').textContent = displayName.toUpperCase();
      document.getElementById('btn-admin-panel').style.display = isAdmin ? 'block' : 'none';

      // Log access
      await push(ref(db, 'access_log'), {
        name: user.displayName || 'Sin nombre',
        email: user.email,
        timestamp: Date.now(),
        role: isAdmin ? 'admin' : 'user'
      });

      showScreen('screen-hmi');
      resetSensorDisplay();
      notify('Bienvenido, ' + displayName, 'success');
      // Los listeners de sensores se inician cuando llega el primer heartbeat
    } else {
      stopSensorListeners();
    }
  });

  // ===== SENSOR LISTENERS =====
  let unsubscribeCurrent = null, unsubscribeVibration = null;

  function startSensorListeners() {
    const connDot = document.getElementById('conn-dot');
    const connText = document.getElementById('conn-text');

    // Corriente
    unsubscribeCurrent = onValue(ref(db, 'sensores/corriente'), (snap) => {
      if (!esp32Conectado) return;
      const val = snap.val();
      if (val !== null) {
        const v = parseFloat(val);
        updateSensorCard('current', v, 10);
        chartHistory.current.push(v);
        if (chartHistory.current.length > MAX_POINTS) chartHistory.current.shift();
        drawChart();
        document.getElementById('last-update-time').textContent = new Date().toLocaleTimeString();
      }
    }, (err) => {
      connDot.style.background = 'var(--red)';
      connText.textContent = 'ERROR DB';
      connText.style.color = 'var(--red)';
    });

    // Vibraci√≥n
    unsubscribeVibration = onValue(ref(db, 'sensores/vibracion'), (snap) => {
      if (!esp32Conectado) return;
      const val = snap.val();
      if (val !== null) {
        const v = parseFloat(val);
        updateSensorCard('vibration', v, 80);
        chartHistory.vibration.push(v);
        if (chartHistory.vibration.length > MAX_POINTS) chartHistory.vibration.shift();
        drawChart();
      }
    });

    // Camara Termica MLX90640
    onValue(ref(db, 'sensores/temperatura'), (snap) => {
      if (!esp32Conectado) return;
      const val = snap.val();
      if (val !== null) {
        const maxima   = parseFloat(val.maxima   ?? 0);
        const ambiente = parseFloat(val.ambiente  ?? 0);
        const promedio = parseFloat(val.promedio  ?? 0);

        document.getElementById('val-thermal').textContent = maxima.toFixed(1);
        document.getElementById('val-thermal-amb').textContent = ambiente.toFixed(1) + ' C';
        document.getElementById('val-thermal-avg').textContent = promedio.toFixed(1) + ' C';

        const pct = Math.min((maxima / 100) * 100, 100);
        document.getElementById('bar-thermal').style.width = pct + '%';

        const dot    = document.getElementById('dot-thermal');
        const status = document.getElementById('status-thermal');
        if (maxima < 60) {
          dot.className = 'card-status-dot';
          status.textContent = 'NORMAL';
        } else if (maxima < 75) {
          dot.className = 'card-status-dot warn';
          status.textContent = 'ADVERTENCIA';
        } else {
          dot.className = 'card-status-dot danger';
          status.textContent = 'CRITICO ‚Äî DETENER';
        }

        document.getElementById('last-update-time').textContent = new Date().toLocaleTimeString();
      }
    });
  }

  function stopSensorListeners() {
    if (unsubscribeCurrent) { unsubscribeCurrent(); unsubscribeCurrent = null; }
    if (unsubscribeVibration) { unsubscribeVibration(); unsubscribeVibration = null; }
  }

  function updateSensorCard(sensor, value, maxVal) {
    const valEl = document.getElementById('val-' + sensor);
    const barEl = document.getElementById('bar-' + sensor);
    const dotEl = document.getElementById('dot-' + sensor);
    const statusEl = document.getElementById('status-' + sensor);

    valEl.textContent = value.toFixed(2);
    const pct = Math.min((value / maxVal) * 100, 100);
    barEl.style.width = pct + '%';

    if (sensor === 'vibration') {
      // Vibraci√≥n: Normal < 20 m/s¬≤, Advertencia >= 40 m/s¬≤
      if (value < 20) {
        dotEl.className = 'card-status-dot';
        statusEl.textContent = 'NORMAL';
      } else if (value < 40) {
        dotEl.className = 'card-status-dot';
        statusEl.textContent = 'NORMAL';
      } else {
        dotEl.className = 'card-status-dot warn';
        statusEl.textContent = 'ADVERTENCIA';
      }
    } else {
      if (pct < 60) {
        dotEl.className = 'card-status-dot';
        statusEl.textContent = 'NORMAL';
      } else if (pct < 85) {
        dotEl.className = 'card-status-dot warn';
        statusEl.textContent = 'ADVERTENCIA';
      } else {
        dotEl.className = 'card-status-dot danger';
        statusEl.textContent = 'ALERTA';
      }
    }
  }

  // ===== CHART =====
  function drawChart() {
    const canvas = document.getElementById('chartCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;
    const W = canvas.width, H = canvas.height;
    ctx.clearRect(0, 0, W, H);

    // Grid
    ctx.strokeStyle = 'rgba(26,58,92,0.5)';
    ctx.lineWidth = 1;
    for (let i = 0; i <= 4; i++) {
      const y = (H / 4) * i;
      ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke();
    }

    function drawLine(data, color, maxVal) {
      if (data.length < 2) return;
      const pts = data.map((v, i) => ({ x: (i / (MAX_POINTS - 1)) * W, y: H - (v / maxVal) * H }));
      // Fill
      const grad = ctx.createLinearGradient(0, 0, 0, H);
      grad.addColorStop(0, color.replace(')', ',0.3)').replace('rgb', 'rgba'));
      grad.addColorStop(1, color.replace(')', ',0)').replace('rgb', 'rgba'));
      ctx.beginPath();
      ctx.moveTo(pts[0].x, H);
      pts.forEach(p => ctx.lineTo(p.x, p.y));
      ctx.lineTo(pts[pts.length-1].x, H);
      ctx.closePath();
      ctx.fillStyle = grad;
      ctx.fill();
      // Line
      ctx.beginPath();
      ctx.moveTo(pts[0].x, pts[0].y);
      pts.forEach(p => ctx.lineTo(p.x, p.y));
      ctx.strokeStyle = color;
      ctx.lineWidth = 2;
      ctx.stroke();
      // Dot
      const last = pts[pts.length-1];
      ctx.beginPath();
      ctx.arc(last.x, last.y, 4, 0, Math.PI*2);
      ctx.fillStyle = color;
      ctx.fill();
    }

    drawLine(chartHistory.current, 'rgb(0,212,255)', 30);
    drawLine(chartHistory.vibration, 'rgb(0,255,157)', 50);

    // Legend
    ctx.font = '10px Share Tech Mono';
    ctx.fillStyle = 'rgb(0,212,255)';
    ctx.fillText('‚Äî CORRIENTE (A)', 10, 16);
    ctx.fillStyle = 'rgb(0,255,157)';
    ctx.fillText('‚Äî VIBRACI√ìN (m/s¬≤)', 10, 30);
  }

  // ===== ADMIN DATA =====
  async function loadAdminData() {
    try {
      const logSnap = await get(ref(db, 'access_log'));
      const logs = logSnap.val() || {};
      const entries = Object.values(logs).sort((a, b) => b.timestamp - a.timestamp);

      const uniqueUsers = [...new Set(entries.map(e => e.email))];
      document.getElementById('stat-users').textContent = uniqueUsers.length;
      document.getElementById('stat-logins').textContent = entries.length;

      // Accesos de hoy
      const now = new Date();
      const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
      const todayEntries = entries.filter(e => e.timestamp >= startOfDay);
      document.getElementById('stat-readings').textContent = todayEntries.length;

      // Load blocked users list
      const blockedSnap = await get(ref(db, 'blocked_users'));
      const blocked = blockedSnap.val() || {};

      const tbody = document.getElementById('admin-table-body');
      if (entries.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text2);font-family:\'Share Tech Mono\',monospace;font-size:11px;padding:30px">SIN REGISTROS AUN</td></tr>';
        return;
      }
      tbody.innerHTML = entries.map(e => {
        const emailKey = e.email.replace(/\./g, '_').replace(/@/g, '_at_');
        const isBlocked = blocked[emailKey] === true;
        const isAdmin = e.role === 'admin';
        const blockBtn = isAdmin ? '' : `
          <button onclick="toggleBlock('${emailKey}', ${isBlocked})"
            style="padding:4px 12px;font-family:'Share Tech Mono',monospace;font-size:9px;
            letter-spacing:1px;cursor:pointer;border:1px solid ${isBlocked ? 'rgba(0,255,157,0.4)' : 'rgba(255,56,96,0.4)'};
            background:${isBlocked ? 'rgba(0,255,157,0.08)' : 'rgba(255,56,96,0.08)'};
            color:${isBlocked ? 'var(--accent2)' : 'var(--red)'};transition:all 0.2s">
            ${isBlocked ? '‚úì DESBLOQUEAR' : '‚úï BLOQUEAR'}
          </button>`;
        return `
        <tr style="${isBlocked ? 'opacity:0.5' : ''}">
          <td>${e.name || '‚Äî'}</td>
          <td class="mono">${e.email}</td>
          <td class="mono">${new Date(e.timestamp).toLocaleString('es-MX')}</td>
          <td><span class="badge ${e.role}">${isAdmin ? '‚öô ADMIN' : '‚óè USUARIO'}</span></td>
          <td>${blockBtn || '<span style="color:var(--text2);font-family:\'Share Tech Mono\',monospace;font-size:9px">‚Äî</span>'}</td>
        </tr>`;
      }).join('');
    } catch(err) {
      console.error('Admin load error:', err);
    }
  }

  // ===== BLOCK / UNBLOCK =====
  window.toggleBlock = async function(emailKey, currentlyBlocked) {
    try {
      if (currentlyBlocked) {
        await set(ref(db, 'blocked_users/' + emailKey), null);
        notify('Usuario desbloqueado', 'success');
      } else {
        await set(ref(db, 'blocked_users/' + emailKey), true);
        notify('Usuario bloqueado', 'info');
      }
      loadAdminData();
    } catch(err) {
      notify('Error al cambiar estado', 'error');
    }
  };

  // ===== PASSWORD TOGGLE =====
  window.togglePassword = function(inputId, btn) {
    const input = document.getElementById(inputId);
    if (!input) return;
    if (input.type === 'password') {
      input.type = 'text';
      btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0112 20c-7 0-11-8-11-8a18.45 18.45 0 015.06-5.94"/><path d="M9.9 4.24A9.12 9.12 0 0112 4c7 0 11 8 11 8a18.5 18.5 0 01-2.16 3.19"/><line x1="1" y1="1" x2="23" y2="23"/></svg>';
    } else {
      input.type = 'password';
      btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>';
    }
  };

  // Borra solo el campo de contrase√±a
  window.clearPassOnly = function(inputId, btnId) {
    const input = document.getElementById(inputId);
    if (input) { input.value = ''; input.type = 'password'; input.focus(); }
    const btn = document.getElementById(btnId);
    if (btn) btn.classList.remove('visible');
    // Reset eye button
    const eyeBtns = document.querySelectorAll('.btn-eye');
    eyeBtns.forEach(b => b.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>');
    // Reset form button and error
    if (inputId === 'login-pass') {
      const btnLogin = document.getElementById('btn-login');
      if (btnLogin) { btnLogin.disabled = false; btnLogin.textContent = 'ACCEDER AL SISTEMA'; }
      document.getElementById('login-error').textContent = '';
    } else if (inputId === 'reg-pass') {
      const btnReg = document.getElementById('btn-register');
      if (btnReg) { btnReg.disabled = false; btnReg.textContent = 'CREAR CUENTA'; }
      document.getElementById('reg-error').textContent = '';
    }
  };

  // ===== CLEAR FIELD HELPERS =====
  window.toggleClear = function(btnId, value) {
    const btn = document.getElementById(btnId);
    if (btn) btn.classList.toggle('visible', value.length > 0);
  };

  window.clearField = function(inputId, btnId) {
    const input = document.getElementById(inputId);
    if (input) { input.value = ''; input.focus(); }
    const btn = document.getElementById(btnId);
    if (btn) btn.classList.remove('visible');

    if (inputId === 'login-email' || inputId === 'login-pass') {
      ['login-email','login-pass'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
      });
      ['clear-login-email','clear-login-pass'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.remove('visible');
      });
      // Reset login button and error
      const btnLogin = document.getElementById('btn-login');
      if (btnLogin) { btnLogin.disabled = false; btnLogin.textContent = 'ACCEDER AL SISTEMA'; }
      document.getElementById('login-error').textContent = '';
    } else if (inputId === 'reg-email' || inputId === 'reg-pass' || inputId === 'reg-name') {
      ['reg-name','reg-email','reg-pass'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
      });
      ['clear-reg-name','clear-reg-email','clear-reg-pass'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.remove('visible');
      });
      // Reset register button and error
      const btnReg = document.getElementById('btn-register');
      if (btnReg) { btnReg.disabled = false; btnReg.textContent = 'CREAR CUENTA'; }
      document.getElementById('reg-error').textContent = '';
    }
  };

  // ===== TIMEOUT DETECTOR ESP32 =====
  // El ESP32 escribe en sensores/heartbeat su propio timestamp local
  // La p√°gina lleva cuenta de cu√°ndo recibi√≥ el √öLTIMO cambio en ese valor
  const TIMEOUT_ESP32 = 6000; // 6 segundos sin cambio = desconectado
  let ultimoHeartbeat = null;
  let esp32Conectado = false;

  function setConectado(estado) {
    if (esp32Conectado === estado) return;
    esp32Conectado = estado;
    const connDot = document.getElementById('conn-dot');
    const connText = document.getElementById('conn-text');
    if (estado) {
      connDot.style.background = 'var(--accent2)';
      connDot.style.boxShadow = '0 0 8px var(--accent2)';
      connText.textContent = 'EN L√çNEA';
      connText.style.color = 'var(--accent2)';
    } else {
      connDot.style.background = 'var(--red)';
      connDot.style.boxShadow = '0 0 8px var(--red)';
      connText.textContent = 'ESP32 DESCONECTADO';
      connText.style.color = 'var(--red)';
      resetSensorDisplay();
    }
  }

  function resetSensorDisplay() {
    document.getElementById('val-current').textContent = '‚Äî';
    document.getElementById('bar-current').style.width = '0%';
    document.getElementById('dot-current').className = 'card-status-dot';
    document.getElementById('status-current').textContent = 'SIN SE√ëAL';

    document.getElementById('val-vibration').textContent = '‚Äî';
    document.getElementById('bar-vibration').style.width = '0%';
    document.getElementById('dot-vibration').className = 'card-status-dot';
    document.getElementById('status-vibration').textContent = 'SIN SE√ëAL';

    document.getElementById('val-thermal').textContent = '‚Äî';
    document.getElementById('bar-thermal').style.width = '0%';
    document.getElementById('dot-thermal').className = 'card-status-dot';
    document.getElementById('status-thermal').textContent = 'SIN SE√ëAL';
    document.getElementById('val-thermal-amb').textContent = '‚Äî ¬∞C';
    document.getElementById('val-thermal-avg').textContent = '‚Äî ¬∞C';

    document.getElementById('last-update-time').textContent = '‚Äî';
  }

  // Escuchar heartbeat ‚Äî cada vez que cambia, el ESP32 est√° vivo
  let sensoresIniciados = false;
  onValue(ref(db, 'sensores/heartbeat'), (snap) => {
    if (snap.val() !== null) {
      ultimoHeartbeat = Date.now();
      setConectado(true);
      // Iniciar listeners de sensores solo cuando llega el primer heartbeat
      if (!sensoresIniciados) {
        sensoresIniciados = true;
        startSensorListeners();
      }
    }
  });

  // Revisar cada 5 segundos si pas√≥ demasiado tiempo sin heartbeat
  setInterval(() => {
    if (ultimoHeartbeat !== null && (Date.now() - ultimoHeartbeat) > TIMEOUT_ESP32) {
      setConectado(false);
    }
  }, 2000);

  // Redraw chart on resize
  window.addEventListener('resize', drawChart);
</script>

</body>
</html>
